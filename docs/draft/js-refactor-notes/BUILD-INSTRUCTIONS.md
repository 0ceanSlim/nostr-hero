# Build Instructions

## Overview

The JavaScript refactor is complete! The new ES6 module system replaces the old global script files.

## Setup & Build

### 1. Install Dependencies

First time setup:
```bash
npm install
```

This installs Vite (the build tool).

### 2. Build the Bundles

**Production build** (minified, optimized):
```bash
npm run build
```

**Development build** (with source maps, watch mode):
```bash
npm run build:watch
```

This creates:
- `www/dist/game.js` - Main game page bundle
- `www/dist/gameIntro.js` - Intro sequence bundle
- `www/dist/newGame.js` - Character creation bundle

### 3. Run the Server

Start your Go server as normal:
```bash
go run main.go
# or
air
```

The game will now load the new ES6 modules!

## Rollback Instructions

If something breaks and you need to revert:

### Option 1: Quick Rollback (Per Page)

In each HTML file (`game.html`, `game-intro.html`, `new-game.html`):

1. **Comment out** the new bundle:
   ```html
   <!-- <script type="module" src="/dist/game.js"></script> -->
   ```

2. **Uncomment** the old scripts block marked with:
   ```html
   <!-- OLD SCRIPTS - Preserved for rollback. To revert: uncomment these...
   ```

### Option 2: Full Rollback (All Pages)

```bash
# Revert all HTML changes
git checkout www/views/game.html
git checkout www/views/game-intro.html
git checkout www/views/new-game.html
```

## Testing Checklist

Test these key workflows:

### Game Page (`/game`)
- [ ] Page loads without console errors
- [ ] Character stats display
- [ ] Inventory drag-and-drop works
- [ ] Equipment slots work
- [ ] Location navigation works
- [ ] Save game works (Ctrl+S)
- [ ] Ground items modal opens
- [ ] Vault UI works

### Intro Page (`/game-intro`)
- [ ] Character generation works
- [ ] Cutscene sequence plays
- [ ] Equipment selection works
- [ ] Save creation succeeds
- [ ] Redirects to game page

### New Game Page (`/new-game`)
- [ ] Character displays
- [ ] Introduction shows
- [ ] Equipment choices work
- [ ] Save creation succeeds

## Development Workflow

### Option 1: Watch Mode (Recommended)

In one terminal:
```bash
npm run build:watch
```

In another terminal:
```bash
air  # or go run main.go
```

This auto-rebuilds when you edit source files in `src/`.

### Option 2: Manual Build

After editing source files:
```bash
npm run build
# Refresh browser
```

## File Structure

```
nostr-hero/
├── src/              # NEW ES6 modules (source)
│   ├── entries/      # Bundle entry points
│   ├── lib/          # Core libraries
│   ├── data/         # Data modules
│   ├── state/        # State management
│   ├── logic/        # Game logic
│   ├── systems/      # Complex systems
│   ├── ui/           # UI modules
│   └── pages/        # Page modules
│
├── www/
│   ├── dist/         # Built bundles (generated by Vite)
│   └── scripts/      # OLD global scripts (preserved for now)
│
├── vite.config.js    # Build configuration
└── package.json      # Dependencies and scripts
```

## Troubleshooting

### "Module not found" errors

Check that all imports use correct paths:
```javascript
import { logger } from '../lib/logger.js';  // ✅ Correct
import { logger } from '../lib/logger';     // ❌ Missing .js
```

### "Cannot find module" in browser

1. Check browser console for 404 errors
2. Verify `www/dist/` directory exists
3. Run `npm run build` to regenerate bundles

### Functions not available globally

Some templates may call functions directly. Add them to `window` in entry files:
```javascript
// In src/entries/game.js
window.myFunction = myFunction;
```

### Old behavior persists

1. Hard refresh browser (Ctrl+Shift+R)
2. Clear browser cache
3. Check that new bundle is loading (Network tab in DevTools)

## Performance Notes

**Production build:**
- ES6 modules with tree-shaking
- Minified and compressed
- Source maps for debugging
- Estimated: ~40% smaller than old system

**Development:**
- Unminified for debugging
- Hot module replacement (HMR) with watch mode
- Faster iteration

## What Changed

**OLD System:**
- 20+ separate `<script>` tags per page
- Global namespace pollution
- No dependency management
- Large bundle size (300KB+)

**NEW System:**
- 1 `<script type="module">` tag per page
- Modular ES6 imports/exports
- Strict dependency hierarchy
- Optimized bundles (~87KB total)

## Next Steps

After successful testing:

1. **Remove old scripts** (Phase 6):
   ```bash
   rm -rf www/scripts/
   ```

2. **Update HTML** - Remove commented old scripts

3. **Commit changes**:
   ```bash
   git add .
   git commit -m "Complete JavaScript refactor to ES6 modules"
   ```
