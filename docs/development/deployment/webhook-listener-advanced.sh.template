#!/bin/bash
# Advanced GitHub Webhook Listener using 'webhook' tool
# Install: https://github.com/adnanh/webhook
# Usage: webhook -hooks hooks.json -verbose

# This script is called by the webhook tool when a push event is received
# Define this in hooks.json (see webhook-hooks.json)

# IMPORTANT: Initialize nvm (Node Version Manager) for npm access
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# If NOT using nvm, use this instead:
# export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"

REPO_PATH="/path/to/nostr-hero"
SERVICE_NAME="your-service-name"
LOG_FILE="/var/log/nostr-hero-deploy.log"

# GitHub status reporting function
update_github_status() {
  local state=$1
  local description=$2

  if [ -n "$GITHUB_TOKEN" ] && [ -n "$COMMIT_SHA" ] && [ -n "$REPO_NAME" ]; then
    curl -s -X POST \
      -H "Authorization: token $GITHUB_TOKEN" \
      -H "Accept: application/vnd.github.v3+json" \
      "https://api.github.com/repos/$REPO_NAME/statuses/$COMMIT_SHA" \
      -d "{\"state\":\"$state\",\"description\":\"$description\",\"context\":\"deployment/webhook\"}" \
      > /dev/null 2>&1
  fi
}

{
  echo "========================================="
  echo "ðŸš€ Deployment started: $(date)"
  echo "Commit: $COMMIT_SHA"
  echo "Repo: $REPO_NAME"
  echo "Pushed by: $PUSHER_NAME"
  echo "========================================="

  # Report pending status to GitHub
  update_github_status "pending" "Deployment in progress..."

  # Navigate to repo
  cd "$REPO_PATH" || {
    echo "âŒ Failed to navigate to repo path: $REPO_PATH"
    update_github_status "error" "Failed to access repository"
    exit 1
  }

  # Print environment info for debugging
  echo "ðŸ” Environment Info:"
  echo "  User: $(whoami)"
  echo "  PATH: $PATH"
  echo "  Node version: $(node --version 2>&1 || echo 'Node not found in PATH')"
  echo "  NPM version: $(npm --version 2>&1 || echo 'NPM not found in PATH')"
  echo "  Working directory: $(pwd)"

  # Pull latest code
  echo "ðŸ“¥ Pulling latest code from main branch..."
  git pull origin main

  if [ $? -eq 0 ]; then
    echo "âœ… Code updated successfully"

    # Install npm dependencies (if package.json changed)
    echo "ðŸ“¦ Installing npm dependencies..."
    # Use full path to npm if not in PATH (adjust this path based on your server)
    NPM_CMD=$(command -v npm || echo "/usr/bin/npm")
    echo "  Using npm at: $NPM_CMD"
    $NPM_CMD install
    if [ $? -ne 0 ]; then
      echo "âŒ npm install failed!"
      update_github_status "failure" "npm install failed"
      exit 1
    fi
    echo "âœ… Dependencies installed"

    # Build frontend assets (CSS/JS)
    echo "ðŸŽ¨ Building frontend assets..."
    $NPM_CMD run build
    if [ $? -ne 0 ]; then
      echo "âŒ npm build failed!"
      update_github_status "failure" "Frontend build failed"
      exit 1
    fi
    echo "âœ… Frontend built successfully"

    # Optional: Run tests before restarting
    # echo "ðŸ§ª Running tests..."
    # go test ./... || {
    #   echo "âŒ Tests failed, aborting deployment"
    #   update_github_status "failure" "Tests failed"
    #   exit 1
    # }

    # Restart service
    echo "ðŸ”„ Restarting $SERVICE_NAME service..."
    sudo systemctl restart "$SERVICE_NAME"

    if [ $? -eq 0 ]; then
      echo "âœ… Service restarted successfully"
      echo "ðŸŽ‰ Deployment completed: $(date)"
      update_github_status "success" "Deployment completed successfully"
    else
      echo "âŒ Service restart failed!"
      update_github_status "failure" "Service restart failed"
      exit 1
    fi
  else
    echo "âŒ Git pull failed!"
    update_github_status "failure" "Git pull failed"
    exit 1
  fi

} 2>&1 | tee -a "$LOG_FILE"
