#!/bin/bash
# Advanced GitHub Webhook Listener using 'webhook' tool
# Install: https://github.com/adnanh/webhook
# Usage: webhook -hooks hooks.json -verbose

# This script is called by the webhook tool when a push event is received
# Define this in hooks.json (see webhook-hooks.json)

# IMPORTANT: Initialize nvm (Node Version Manager) for npm access
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# IMPORTANT: Add Go to PATH
export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin

REPO_PATH="/path/to/pubkey-quest"
SERVICE_NAME="your-service-name"
LOG_FILE="/var/log/pubkey-quest-deploy.log"

# GitHub status reporting function
update_github_status() {
  local state=$1
  local description=$2

  if [ -n "$GITHUB_TOKEN" ] && [ -n "$COMMIT_SHA" ] && [ -n "$REPO_NAME" ]; then
    curl -s -X POST \
      -H "Authorization: token $GITHUB_TOKEN" \
      -H "Accept: application/vnd.github.v3+json" \
      "https://api.github.com/repos/$REPO_NAME/statuses/$COMMIT_SHA" \
      -d "{\"state\":\"$state\",\"description\":\"$description\",\"context\":\"deployment/webhook\"}" \
      > /dev/null 2>&1
  fi
}

{
  echo "========================================="
  echo "ðŸš€ Deployment started: $(date)"
  echo "Commit: $COMMIT_SHA"
  echo "Repo: $REPO_NAME"
  echo "Pushed by: $PUSHER_NAME"
  echo "========================================="

  # Report pending status to GitHub
  update_github_status "pending" "Deployment in progress..."

  # Navigate to repo
  cd "$REPO_PATH" || {
    echo "âŒ Failed to navigate to repo path: $REPO_PATH"
    update_github_status "error" "Failed to access repository"
    exit 1
  }

  # Print environment info for debugging
  echo "ðŸ” Environment Info:"
  echo "  User: $(whoami)"
  echo "  PATH: $PATH"
  echo "  Node version: $(node --version 2>&1 || echo 'Node not found in PATH')"
  echo "  NPM version: $(npm --version 2>&1 || echo 'NPM not found in PATH')"
  echo "  Go version: $(go version 2>&1 || echo 'Go not found in PATH')"
  echo "  Working directory: $(pwd)"

  # Pull latest code
  echo "ðŸ“¥ Pulling latest code from main branch..."
  git pull origin main

  if [ $? -eq 0 ]; then
    echo "âœ… Code updated successfully"

    # Install npm dependencies (if package.json changed)
    echo "ðŸ“¦ Installing npm dependencies..."
    NPM_CMD=$(command -v npm || echo "/usr/bin/npm")
    echo "  Using npm at: $NPM_CMD"
    $NPM_CMD install
    if [ $? -ne 0 ]; then
      echo "âŒ npm install failed!"
      update_github_status "failure" "npm install failed"
      exit 1
    fi
    echo "âœ… Dependencies installed"

    # Build frontend assets (CSS/JS)
    echo "ðŸŽ¨ Building frontend assets..."
    $NPM_CMD run build
    if [ $? -ne 0 ]; then
      echo "âŒ npm build failed!"
      update_github_status "failure" "Frontend build failed"
      exit 1
    fi
    echo "âœ… Frontend built successfully"

    # Download Go dependencies (from root, go.mod is at root now)
    echo "ðŸ“¦ Installing Go dependencies..."
    echo "  Checking for Go: $(which go 2>&1 || echo 'go not found in PATH')"
    echo "  Go version: $(go version 2>&1 || echo 'go command failed')"
    echo "  Working directory: $(pwd)"
    echo "  Running: go mod download"
    go mod download
    if [ $? -ne 0 ]; then
      echo "âŒ Go mod download failed!"
      update_github_status "failure" "Go dependencies failed"
      exit 1
    fi
    echo "âœ… Go dependencies installed"

    # Build CODEX first (needed for migration)
    echo "========================================="
    echo "ðŸŽ® Building CODEX..."
    echo "========================================="

    echo "ðŸ”¨ Building CODEX binary..."
    go build -o codex ./cmd/codex
    if [ $? -ne 0 ]; then
      echo "âŒ CODEX build failed!"
      update_github_status "failure" "CODEX build failed"
      exit 1
    fi
    echo "âœ… CODEX built successfully"

    # Run CODEX database migration
    echo "ðŸ”„ Running CODEX database migration..."
    ./codex --migrate
    if [ $? -ne 0 ]; then
      echo "âŒ CODEX migration failed!"
      update_github_status "failure" "CODEX migration failed"
      exit 1
    fi
    echo "âœ… CODEX migration completed"

    # Build server binary
    echo "ðŸ”¨ Building server binary..."
    go build -o pubkey-quest ./cmd/server
    if [ $? -ne 0 ]; then
      echo "âŒ Go build failed!"
      update_github_status "failure" "Go build failed"
      exit 1
    fi
    echo "âœ… Server binary built successfully"

    # Restart main service
    echo "ðŸ”„ Restarting $SERVICE_NAME service..."
    sudo systemctl restart "$SERVICE_NAME"

    if [ $? -eq 0 ]; then
      echo "âœ… Main service restarted successfully"
    else
      echo "âŒ Main service restart failed!"
      update_github_status "failure" "Main service restart failed"
      exit 1
    fi

    # Restart CODEX service (if running separately)
    echo "ðŸ”„ Restarting codex.service..."
    sudo systemctl restart codex

    if [ $? -eq 0 ]; then
      echo "âœ… CODEX service restarted successfully"
      echo "ðŸŽ‰ Deployment completed: $(date)"
      update_github_status "success" "Deployment completed successfully"
    else
      echo "âŒ CODEX service restart failed!"
      update_github_status "failure" "CODEX service restart failed"
      exit 1
    fi
  else
    echo "âŒ Git pull failed!"
    update_github_status "failure" "Git pull failed"
    exit 1
  fi

} 2>&1 | tee -a "$LOG_FILE"
