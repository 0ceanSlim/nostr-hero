#!/bin/bash
# Advanced GitHub Webhook Listener using 'webhook' tool
# Install: https://github.com/adnanh/webhook
# Usage: webhook -hooks hooks.json -verbose

# This script is called by the webhook tool when a push event is received
# Define this in hooks.json (see webhook-hooks.json)

REPO_PATH="/path/to/nostr-hero"
SERVICE_NAME="your-service-name"
LOG_FILE="/var/log/nostr-hero-deploy.log"

# GitHub status reporting function
update_github_status() {
  local state=$1
  local description=$2

  if [ -n "$GITHUB_TOKEN" ] && [ -n "$COMMIT_SHA" ] && [ -n "$REPO_NAME" ]; then
    curl -s -X POST \
      -H "Authorization: token $GITHUB_TOKEN" \
      -H "Accept: application/vnd.github.v3+json" \
      "https://api.github.com/repos/$REPO_NAME/statuses/$COMMIT_SHA" \
      -d "{\"state\":\"$state\",\"description\":\"$description\",\"context\":\"deployment/webhook\"}" \
      > /dev/null 2>&1
  fi
}

{
  echo "========================================="
  echo "ðŸš€ Deployment started: $(date)"
  echo "Commit: $COMMIT_SHA"
  echo "Repo: $REPO_NAME"
  echo "Pushed by: $PUSHER_NAME"
  echo "========================================="

  # Report pending status to GitHub
  update_github_status "pending" "Deployment in progress..."

  # Navigate to repo
  cd "$REPO_PATH" || {
    echo "âŒ Failed to navigate to repo path: $REPO_PATH"
    update_github_status "error" "Failed to access repository"
    exit 1
  }

  # Pull latest code
  echo "ðŸ“¥ Pulling latest code from main branch..."
  git pull origin main

  if [ $? -eq 0 ]; then
    echo "âœ… Code updated successfully"

    # Optional: Run tests before restarting
    # echo "ðŸ§ª Running tests..."
    # go test ./... || {
    #   echo "âŒ Tests failed, aborting deployment"
    #   update_github_status "failure" "Tests failed"
    #   exit 1
    # }

    # Restart service
    echo "ðŸ”„ Restarting $SERVICE_NAME service..."
    sudo systemctl restart "$SERVICE_NAME"

    if [ $? -eq 0 ]; then
      echo "âœ… Service restarted successfully"
      echo "ðŸŽ‰ Deployment completed: $(date)"
      update_github_status "success" "Deployment completed successfully"
    else
      echo "âŒ Service restart failed!"
      update_github_status "failure" "Service restart failed"
      exit 1
    fi
  else
    echo "âŒ Git pull failed!"
    update_github_status "failure" "Git pull failed"
    exit 1
  fi

} 2>&1 | tee -a "$LOG_FILE"
