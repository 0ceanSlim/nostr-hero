name: "Deploy: test.pubkey.quest"

on:
  push:
    branches: [main]

jobs:
  deploy-test:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Build (failure here stops the workflow, old binaries stay running) ──

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend
        run: npm run build

      - name: Build codex
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "$(git rev-parse --short HEAD)")
          go build -ldflags "-X main.Version=${VERSION}" -o codex ./cmd/codex

      - name: Verify codex binary
        run: |
          test -f ./codex || { echo "::error::codex binary not found"; exit 1; }
          echo "codex: $(./codex -version)"

      - name: Run database migration
        run: ./codex -migrate

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate swagger docs
        run: swag init -g cmd/server/api/routes.go -o docs/api/swagger --parseDependency

      - name: Build server
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "$(git rev-parse --short HEAD)")
          go build -ldflags "-X main.Version=${VERSION}" -o pubkey-quest ./cmd/server

      - name: Verify server binary
        run: |
          test -f ./pubkey-quest || { echo "::error::pubkey-quest binary not found"; exit 1; }
          echo "server: $(./pubkey-quest -version)"

      # ── Tests (run but don't block deployment) ──

      - name: Run API tests
        id: api_tests
        continue-on-error: true
        run: go test -v ./tests/... 2>&1 | tee test-results.txt

      - name: Validate game data
        id: validate
        continue-on-error: true
        run: ./codex -validate 2>&1 | tee validation-results.txt

      # ── Deploy ──

      - name: Restart test server
        run: sudo systemctl restart pubkey-quest-test

      - name: Verify test server is running
        run: |
          sleep 2
          if ! systemctl is-active --quiet pubkey-quest-test; then
            echo "::error::pubkey-quest-test failed to start"
            systemctl status pubkey-quest-test --no-pager || true
            journalctl -u pubkey-quest-test --no-pager -n 20 || true
            exit 1
          fi
          echo "pubkey-quest-test is running"

      - name: Restart codex
        run: sudo systemctl restart codex

      - name: Verify codex is running
        run: |
          sleep 2
          if ! systemctl is-active --quiet codex; then
            echo "::error::codex service failed to start"
            systemctl status codex --no-pager || true
            journalctl -u codex --no-pager -n 20 || true
            exit 1
          fi
          echo "codex service is running"

      # ── Report ──

      - name: Write job summary
        if: always()
        run: |
          echo "## Deploy: test.pubkey.quest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`$(git rev-parse --short HEAD)\` — $(git log -1 --pretty=%s)" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Build" >> $GITHUB_STEP_SUMMARY
          if [ -f ./pubkey-quest ] && [ -f ./codex ]; then
            echo "- server: \`$(./pubkey-quest -version 2>&1)\`" >> $GITHUB_STEP_SUMMARY
            echo "- codex: \`$(./codex -version 2>&1)\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Build failed** — binaries not found." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Services" >> $GITHUB_STEP_SUMMARY
          if systemctl is-active --quiet pubkey-quest-test 2>/dev/null; then
            echo "- pubkey-quest-test: running" >> $GITHUB_STEP_SUMMARY
          else
            echo "- pubkey-quest-test: **NOT RUNNING**" >> $GITHUB_STEP_SUMMARY
          fi
          if systemctl is-active --quiet codex 2>/dev/null; then
            echo "- codex: running" >> $GITHUB_STEP_SUMMARY
          else
            echo "- codex: **NOT RUNNING**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.api_tests.outcome }}" = "success" ]; then
            echo "- API Tests: passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- API Tests: **FAILED** (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.validate.outcome }}" = "success" ]; then
            echo "- Game Data Validation: passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Game Data Validation: **FAILED** (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          # Show test output if tests failed
          if [ "${{ steps.api_tests.outcome }}" != "success" ] && [ -f test-results.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Test output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.validate.outcome }}" != "success" ] && [ -f validation-results.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Validation output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat validation-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
