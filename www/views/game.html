{{define "title"}}Nostr Hero - Game{{end}} {{define "view"}}
<!-- Hidden Game State Storage -->
<div id="game-state" style="display: none">
  <div id="character-data">
    {"hp": 0, "max_hp": 0, "mana": 0, "max_mana": 0, "location": "", "fatigue":
    0}
  </div>
  <div id="inventory-data">[]</div>
  <div id="equipment-data">{}</div>
  <div id="spell-data">[]</div>
  <div id="location-data">{"current": "", "discovered": []}</div>
  <div id="combat-data">null</div>
</div>

<!-- Static Game Data Storage -->
<div id="static-data" style="display: none">
  <div id="all-items">[]</div>
  <div id="all-spells">[]</div>
  <div id="all-monsters">[]</div>
  <div id="all-locations">[]</div>
  <div id="all-packs">[]</div>
</div>

<!-- Message Area (Fixed Position) -->
<div
  id="message-area"
  class="fixed z-50 max-w-sm space-y-2 top-4 right-4"
></div>

<!-- Main Game Container - Full Screen with Dark Win95 Style -->
<div
  id="game-app"
  class="fixed inset-0 flex items-start justify-start overflow-hidden text-white"
  style="background: #000000"
>
  <!-- Dark Win95 Style Game Window - Fixed 756x503 base size, scaled to fit -->
  <div
    id="game-window"
    class="flex flex-col"
    style="
      width: 756px;
      height: 503px;
      background: #2a2a2a;
      border-top: 2px solid #4a4a4a;
      border-left: 2px solid #4a4a4a;
      border-right: 2px solid #000000;
      border-bottom: 2px solid #000000;
      box-shadow: inset 1px 1px 0 #3a3a3a, inset -1px -1px 0 #1a1a1a;
      transform-origin: top left;
    "
  >
    <!-- Main Content Area: 2 columns (556px left, 200px right) -->
    <div class="flex flex-1 overflow-hidden">
      <!-- LEFT COLUMN (556px) - Scene/Text side-by-side + Actions below -->
      <div style="width: 556px;" class="flex flex-col">
        <!-- Scene and Text Box Row -->
        <div class="flex" style="height: 347px;">
          <!-- Text Box -->
          <div style="width: 209px;">
            {{template "game/game-text.html"}}
          </div>
          <!-- Scene (4:3 ratio) -->
          <div style="width: 347px;">
            {{template "game/scene.html"}}
          </div>
        </div>
        <!-- Action Buttons -->
        {{template "game/action-buttons.html"}}
      </div>

      <!-- RIGHT COLUMN (200px) - Character Info + Inventory + Menu Buttons -->
      <div style="width: 200px;" class="flex flex-col">
        {{template "game/player-stats.html"}}

        <!-- Tabbed Content Area (Inventory/Equipment) -->
        <div
          class="flex flex-col overflow-hidden"
          style="
            flex: 1;
            min-height: 0;
            background: #2a2a2a;
            border-top: 2px solid #1a1a1a;
            border-left: 2px solid #1a1a1a;
            border-right: 2px solid #3a3a3a;
            border-bottom: 2px solid #3a3a3a;
            box-shadow: inset -1px -1px 0 #4a4a4a, inset 1px 1px 0 #000000;
          "
        >
          <!-- Tab Content -->
          <div style="flex: 1; min-height: 0; padding: 4px; overflow-y: auto;">
            {{template "game/tabs/equipment.html"}}
            {{template "game/tabs/inventory.html"}}
            {{template "game/tabs/spells.html"}}
            {{template "game/tabs/questlog.html"}}
            {{template "game/tabs/stats.html"}}
            {{template "game/tabs/music.html"}}
            {{template "game/tabs/settings.html"}}
          </div>
        </div>

        {{template "game/tab-buttons.html"}}
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    function switchTab(tabName) {
      const tabs = ["equipment", "inventory", "spells", "questlog", "stats", "music", "settings"];
      const panels = {
        equipment: document.getElementById("equipment-panel"),
        inventory: document.getElementById("inventory-panel"),
        spells: document.getElementById("spells-panel"),
        questlog: document.getElementById("questlog-panel"),
        stats: document.getElementById("stats-panel"),
        music: document.getElementById("music-panel"),
        settings: document.getElementById("settings-panel"),
      };
      const buttons = {
        equipment: document.getElementById("tab-equipment"),
        inventory: document.getElementById("tab-inventory"),
        spells: document.getElementById("tab-spells"),
        questlog: document.getElementById("tab-questlog"),
        stats: document.getElementById("tab-stats"),
        music: document.getElementById("tab-music"),
        settings: document.getElementById("btn-settings"),
      };

      tabs.forEach((tab) => {
        if (tab === tabName) {
          buttons[tab].style = "background: #1a1a1a; border-top: 2px solid #000000; border-left: 2px solid #000000; border-right: 2px solid #3a3a3a; border-bottom: 2px solid #3a3a3a;";
          panels[tab].classList.remove("hidden");
        } else {
          buttons[tab].style = "background: #2a2a2a; border-top: 2px solid #4a4a4a; border-left: 2px solid #4a4a4a; border-right: 2px solid #1a1a1a; border-bottom: 2px solid #1a1a1a;";
          panels[tab].classList.add("hidden");
        }
      });
    }

    // Game UI Scaling System
    function scaleGameUI() {
      const gameWindow = document.getElementById('game-window');
      if (!gameWindow) return;

      const baseWidth = 756;
      const baseHeight = 503;
      const baseRatio = baseWidth / baseHeight; // ~1.503

      // Get viewport dimensions
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const viewportRatio = viewportWidth / viewportHeight;

      let scaleX, scaleY;

      // First, scale uniformly to fit within viewport (maintaining aspect ratio)
      const uniformScale = Math.min(viewportWidth / baseWidth, viewportHeight / baseHeight);

      // Then stretch to fill the remaining space
      if (viewportRatio > baseRatio) {
        // Viewport is wider - scale height uniformly, then stretch width to fill
        scaleY = uniformScale;
        scaleX = viewportWidth / baseWidth;
      } else {
        // Viewport is taller - scale width uniformly, then stretch height to fill
        scaleX = uniformScale;
        scaleY = viewportHeight / baseHeight;
      }

      // Apply the transform
      gameWindow.style.transform = `scale(${scaleX}, ${scaleY})`;
    }

    // Initialize scaling on page load
    window.addEventListener('load', () => {
      scaleGameUI();
      // Set inventory tab as default
      switchTab('inventory');
    });

    // Re-scale when window is resized
    window.addEventListener('resize', scaleGameUI);

    // Action button handlers
    function openBadges() {
      showMessage("🏆 Badges system coming soon!", "info");
    }

    function openSettings() {
      switchTab('settings');
    }

    function manualSaveGame() {
      // Confirm before overwriting
      if (!confirm('⚠️ This will overwrite your existing save file. Are you sure you want to continue?')) {
        return;
      }

      const saveBtn = document.getElementById('manual-save-btn');
      const saveStatus = document.getElementById('save-status');

      saveBtn.disabled = true;
      saveBtn.textContent = '💾 Saving...';
      saveStatus.textContent = 'Overwriting save file...';
      saveStatus.className = 'mt-2 text-xs text-yellow-400';

      saveGame().then(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = '💾 Save Now';
        saveStatus.textContent = '✅ Save file overwritten successfully!';
        saveStatus.className = 'mt-2 text-xs text-green-400';

        setTimeout(() => {
          saveStatus.textContent = '';
        }, 3000);
      }).catch((error) => {
        saveBtn.disabled = false;
        saveBtn.textContent = '💾 Save Now';
        saveStatus.textContent = '❌ Save failed: ' + error.message;
        saveStatus.className = 'mt-2 text-xs text-red-400';
      });
    }

    function reportBug() {
      const bugReportUrl = "https://github.com/0ceanSlim/nostr-hero/issues/new?template=bug_report.md";
      showMessage("🐛 Opening bug report...", "info");
      window.open(bugReportUrl, "_blank");
    }

    function logout() {
      if (confirm("Are you sure you want to logout? Any unsaved progress will be lost.")) {
        showMessage("🚪 Logging out...", "info");
        if (window.sessionManager) {
          window.sessionManager.logout();
        }
        setTimeout(() => {
          window.location.href = "/";
        }, 1000);
      }
    }
  </script>
  <script src="/scripts/core/session-manager.js?v=20251025h"></script>
  <script src="/scripts/pages/game-ui.js?v=20251025h"></script>
  <script src="/scripts/core/auth.js?v=20251025h"></script>
  <script src="/scripts/systems/character-generator.js?v=20251025h"></script>
  <script src="/scripts/systems/game-state.js?v=20251025h"></script>
  <script src="/scripts/systems/game-logic.js?v=20251025h"></script>
  <script src="/scripts/systems/save-system.js?v=20251025h"></script>
  <script src="/scripts/systems/inventory-interactions.js?v=20251025h"></script>
  <script src="/scripts/pages/startup.js?v=20251025h"></script>

  {{end}}
</div>
