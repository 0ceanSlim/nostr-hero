{{define "profile-dropdown"}}
<!-- Profile Dropdown (Only visible when logged in) -->
<div id="profile-dropdown-container" class="relative hidden">
  <button
    onclick="toggleProfileDropdown()"
    class="win95-button pixel-clip p-2 hover:opacity-80 transition"
    id="profile-btn"
  >
    <div class="flex items-center gap-1">
      <!-- Profile Picture -->
      <img
        id="profile-pfp"
        src=""
        alt="Profile"
        class="pfp-24"
        style="display: none;"
      />
      <!-- Default Avatar (shown if no pfp) -->
      <span id="profile-default-avatar" class="text-sm">ğŸ‘¤</span>

      <!-- Display Name -->
      <span id="profile-display-name" class="hidden sm:inline text-xs max-w-20 truncate">
        Loading...
      </span>

      <!-- Dropdown Arrow -->
      <svg
        class="w-3 h-3 transition-transform"
        id="profile-dropdown-arrow"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </div>
  </button>

  <!-- Dropdown Menu -->
  <div
    id="profile-dropdown-menu"
    class="absolute right-0 hidden mt-2 win95-outset pixel-clip shadow-lg"
    style="min-width: 12rem; z-index: 50; border: 4px solid var(--color-textPrimary);"
  >
    <ul class="py-2">
      <!-- User Info Header -->
      <li class="px-4 py-2 border-b" style="border-color: var(--color-bgTertiary);">
        <div class="flex items-center gap-2">
          <img
            id="profile-menu-pfp"
            src=""
            alt="Profile"
            class="pfp-32"
            style="display: none;"
          />
          <span id="profile-menu-default-avatar" class="text-2xl">âš”ï¸</span>
          <div class="flex-1 overflow-hidden">
            <div id="profile-menu-display-name" class="font-bold text-sm truncate" style="color: var(--color-textHighlighted);">
              Loading...
            </div>
            <div id="profile-menu-npub" class="text-xs truncate" style="color: var(--color-textMuted);">
              npub...
            </div>
          </div>
        </div>
      </li>

      <!-- Menu Options -->
      <li>
        <a
          href="/saves"
          class="block px-4 py-2 whitespace-nowrap transition-colors"
          style="color: var(--color-textPrimary);"
          onmouseover="this.style.backgroundColor='var(--color-textHighlighted)'; this.style.color='var(--color-bgPrimary)'"
          onmouseout="this.style.backgroundColor=''; this.style.color='var(--color-textPrimary)'"
        >
          ğŸ’¾ My Saves
        </a>
      </li>
      <li>
        <a
          href="/settings"
          class="block px-4 py-2 whitespace-nowrap transition-colors"
          style="color: var(--color-textPrimary);"
          onmouseover="this.style.backgroundColor='var(--color-textHighlighted)'; this.style.color='var(--color-bgPrimary)'"
          onmouseout="this.style.backgroundColor=''; this.style.color='var(--color-textPrimary)'"
        >
          âš™ï¸ Settings
        </a>
      </li>
      <li>
        <button
          onclick="handleProfileLogout()"
          class="w-full text-left block px-4 py-2 whitespace-nowrap transition-colors"
          style="color: rgb(239, 68, 68);"
          onmouseover="this.style.backgroundColor='rgb(239, 68, 68)'; this.style.color='var(--color-bgPrimary)'"
          onmouseout="this.style.backgroundColor=''; this.style.color='rgb(239, 68, 68)'"
        >
          ğŸšª Logout
        </button>
      </li>
    </ul>
  </div>
</div>

<script>
// Toggle profile dropdown
function toggleProfileDropdown() {
  const menu = document.getElementById('profile-dropdown-menu');
  const arrow = document.getElementById('profile-dropdown-arrow');
  menu.classList.toggle('hidden');
  if (menu.classList.contains('hidden')) {
    arrow.style.transform = 'rotate(0deg)';
  } else {
    arrow.style.transform = 'rotate(180deg)';
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const container = document.getElementById('profile-dropdown-container');
  const menu = document.getElementById('profile-dropdown-menu');
  const arrow = document.getElementById('profile-dropdown-arrow');

  if (container && !container.contains(event.target)) {
    menu?.classList.add('hidden');
    if (arrow) arrow.style.transform = 'rotate(0deg)';
  }
});

// Handle logout from profile dropdown
async function handleProfileLogout() {
  if (window.sessionManager) {
    try {
      await window.sessionManager.logout();
      showMessage('âœ… Logged out successfully', 'success');
      // Reload to update UI
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    } catch (error) {
      console.error('Logout error:', error);
      showMessage('âŒ Logout failed: ' + error.message, 'error');
    }
  }
}

// Update profile UI with user data
function updateProfileUI(profileData) {
  const container = document.getElementById('profile-dropdown-container');
  const pfp = document.getElementById('profile-pfp');
  const menuPfp = document.getElementById('profile-menu-pfp');
  const defaultAvatar = document.getElementById('profile-default-avatar');
  const menuDefaultAvatar = document.getElementById('profile-menu-default-avatar');
  const displayName = document.getElementById('profile-display-name');
  const menuDisplayName = document.getElementById('profile-menu-display-name');
  const menuNpub = document.getElementById('profile-menu-npub');

  if (!profileData || !profileData.npub) return;

  // Show profile dropdown container
  container?.classList.remove('hidden');

  // Set display name (or fallback to npub)
  const name = profileData.display_name || profileData.name || profileData.npub.slice(0, 10) + '...';
  if (displayName) displayName.textContent = name;
  if (menuDisplayName) menuDisplayName.textContent = name;
  if (menuNpub) menuNpub.textContent = profileData.npub.slice(0, 16) + '...';

  // Set profile picture if available
  if (profileData.picture) {
    if (pfp) {
      pfp.src = profileData.picture;
      pfp.style.display = 'block';
    }
    if (menuPfp) {
      menuPfp.src = profileData.picture;
      menuPfp.style.display = 'block';
    }
    if (defaultAvatar) defaultAvatar.style.display = 'none';
    if (menuDefaultAvatar) menuDefaultAvatar.style.display = 'none';
  } else {
    // Use default avatar
    if (pfp) pfp.style.display = 'none';
    if (menuPfp) menuPfp.style.display = 'none';
    if (defaultAvatar) defaultAvatar.style.display = 'inline';
    if (menuDefaultAvatar) menuDefaultAvatar.style.display = 'inline';
  }
}

// Hide profile dropdown when not logged in
function hideProfileUI() {
  const container = document.getElementById('profile-dropdown-container');
  container?.classList.add('hidden');
}

// Listen for profile updates
if (typeof window !== 'undefined') {
  window.addEventListener('profile-updated', (event) => {
    if (event.detail) {
      updateProfileUI(event.detail);
    }
  });

  window.addEventListener('auth-changed', (event) => {
    if (!event.detail || !event.detail.isAuthenticated) {
      hideProfileUI();
    }
  });
}
</script>
{{end}}
