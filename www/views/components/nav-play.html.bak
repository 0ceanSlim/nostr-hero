{{define "nav-play"}}
<!-- Login/Logout Button -->
<button
  id="login-btn"
  onclick="handleLoginClick()"
  class="login-button-yellow pixel-clip p-2 hover:opacity-80 transition flex-shrink-0"
  title="Login"
>
  <span class="text-base" id="login-btn-text">
    ğŸ—ï¸ Login
  </span>
</button>

<!-- Login Modal (Hidden by default) -->
<div
  id="login-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideLoginModal()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6 md:p-8">
      <!-- Header -->
      <div class="text-center mb-3">
        <h2 class="text-xl sm:text-3xl font-bold mb-1" style="color: var(--color-textHighlighted);">âš”ï¸ Nostr Hero âš”ï¸</h2>
        <p class="text-xs sm:text-sm" style="color: var(--color-textMuted);">Login with your Nostr identity to save your progress</p>
      </div>

      <!-- Auth Result (inline status messages) -->
      <div id="auth-result" class="mb-3"></div>

      <!-- Login Methods -->
      <div class="space-y-2 mb-3">
        <!-- Generate New Keys -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">âœ¨</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">New to Nostr?</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Generate a new keypair and start your adventure</p>
              <button
                onclick="generateNewKeys()"
                class="new-nostr-button-purple px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                âœ¨ Generate Keys
              </button>
            </div>
          </div>
        </div>

        <!-- Browser Extension -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">ğŸ”—</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">Browser Extension</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Use Alby, nos2x, or other Nostr browser extensions</p>
              <button
                onclick="loginWithExtension()"
                class="action-button-primary px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                ğŸ”— Extension
              </button>
            </div>
          </div>
        </div>

        <!-- Amber (Android) -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">ğŸ“±</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">Amber Signer</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Android app for secure key management</p>
              <button
                onclick="loginWithAmber()"
                class="amber-button-orange px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                ğŸ“± Amber
              </button>
            </div>
          </div>
        </div>

        <!-- Private Key -->
        <div class="win95-inset p-2 sm:p-3">
          <div class="flex items-start gap-2 sm:gap-3">
            <div class="text-2xl sm:text-4xl">ğŸ—ï¸</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1 text-xs sm:text-sm" style="color: var(--color-textPrimary);">Private Key</h4>
              <p class="text-[10px] sm:text-sm mb-1" style="color: var(--color-textMuted);">Login with your nsec or hex private key (encrypted with password for session)</p>
              <button
                onclick="showPrivateKeyForm()"
                class="private-key-button-red px-2 py-1.5 pixel-clip text-xs sm:text-sm w-full sm:w-auto"
              >
                ğŸ—ï¸ Private Key
              </button>
            </div>
          </div>
        </div>
      </div>


      <!-- Info Section -->
      <div class="text-[10px] sm:text-xs text-center mb-2" style="color: var(--color-textMuted);">
        <p>ğŸ” Your keys are never sent to our servers</p>
        <p class="mt-0.5">All signing happens locally in your browser or signer app</p>
      </div>

      <!-- Close Button -->
      <button
        onclick="hideLoginModal()"
        class="w-full win95-button pixel-clip px-2 py-1.5 text-xs font-medium"
        style="color: var(--color-textPrimary);"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Private Key Modal (Initially Hidden) -->
<div
  id="private-key-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hidePrivateKeyForm()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-md max-h-[95vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <h3 class="text-lg sm:text-2xl font-bold mb-2 text-center" style="color: var(--color-textHighlighted);">ğŸ—ï¸ Private Key</h3>
      <div class="space-y-2">
        <div>
          <label class="block text-xs font-medium mb-1" style="color: var(--color-textSecondary);">Private Key</label>
          <input
            type="password"
            id="private-key-modal-input"
            class="w-full win95-inset px-2 py-1.5 focus:outline-none font-mono text-xs"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="nsec1... or hex private key"
          />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1" style="color: var(--color-textSecondary);">Encryption Password</label>
          <input
            type="password"
            id="encryption-password-modal-input"
            class="w-full win95-inset px-2 py-1.5 focus:outline-none text-xs"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="Password to encrypt your key"
          />
        </div>
        <div class="text-xs win95-inset p-2" style="color: var(--color-textMuted);">
          <p>ğŸ”’ Your private key will be encrypted with your password and stored securely for this session only.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button
            onclick="loginWithPrivateKeyAndPassword()"
            class="flex-1 action-button-primary pixel-clip px-2 py-1.5 text-xs"
          >
            ğŸ”‘ Login
          </button>
          <button
            onclick="hidePrivateKeyForm()"
            class="flex-1 win95-button pixel-clip px-2 py-1.5 text-xs"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Generated Keys Modal (Initially Hidden) -->
<div
  id="generated-keys-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideGeneratedKeys()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-[95vw] sm:max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-2 sm:p-6">
      <h3 class="text-lg sm:text-2xl font-bold mb-2 text-center" style="color: var(--color-textHighlighted);">âœ¨ New Keys!</h3>
      <div class="space-y-2">
        <div>
          <label class="block text-xs font-bold mb-1" style="color: var(--color-textHighlighted);">ğŸ“„ Public Key (npub)</label>
          <div class="flex flex-col sm:flex-row gap-1">
            <div class="flex-1 win95-inset p-1.5 text-[10px] sm:text-xs font-mono break-all overflow-x-auto" style="color: var(--color-textHighlighted); background: var(--color-bgPrimary); max-height: 60px;" id="gen-npub"></div>
            <button onclick="copyToClipboard('gen-npub', 'ğŸ“„ Public key')" class="action-button-secondary px-3 py-1.5 pixel-clip text-xs flex-shrink-0">ğŸ“‹ Copy</button>
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold mb-1" style="color: rgb(239, 68, 68);">ğŸ”’ Private Key (nsec)</label>
          <div class="flex flex-col sm:flex-row gap-1">
            <div class="flex-1 win95-inset p-1.5 text-[10px] sm:text-xs font-mono break-all overflow-x-auto" style="color: rgb(239, 68, 68); background: var(--color-bgPrimary); max-height: 60px;" id="gen-nsec"></div>
            <button onclick="copyToClipboard('gen-nsec', 'ğŸ”’ Private key')" class="action-button-secondary px-3 py-1.5 pixel-clip text-xs flex-shrink-0">ğŸ“‹ Copy</button>
          </div>
        </div>
        <div class="text-[10px] sm:text-xs win95-outset p-2 pixel-clip" style="background: rgb(153, 27, 27); color: rgb(255, 255, 255); border: 2px solid rgb(239, 68, 68);">
          <p class="font-bold text-xs sm:text-sm">âš ï¸ CRITICAL - SAVE YOUR PRIVATE KEY!</p>
          <p class="mt-1">This is the ONLY way to access your account. <strong>It cannot be recovered or changed by anyone.</strong> Copy and store it in a password manager or write it down securely. Anyone with this key controls your account.</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button
            onclick="useGeneratedKeys()"
            class="flex-1 action-button-primary pixel-clip px-2 py-1.5 text-xs"
          >
            âœ… I Saved It
          </button>
          <button
            onclick="hideGeneratedKeys()"
            class="flex-1 win95-button pixel-clip px-2 py-1.5 text-xs"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variable to store generated private key
if (typeof generatedPrivateKey === 'undefined') {
  var generatedPrivateKey = null;
}

// Show auth result inline (like Grain)
function showAuthResult(type, message) {
  let className, icon;

  if (type === 'success') {
    className = 'win95-outset p-3 rounded';
    icon = 'âœ…';
  } else if (type === 'error') {
    className = 'win95-outset p-3 rounded';
    icon = 'âŒ';
  } else if (type === 'loading') {
    className = 'win95-outset p-3 rounded';
    icon = 'â³';
  } else {
    className = 'win95-inset p-3 rounded';
    icon = 'â„¹ï¸';
  }

  const resultDiv = document.getElementById('auth-result');
  if (resultDiv) {
    resultDiv.innerHTML = `<div class="${className}" style="color: var(--color-textPrimary);"><p>${icon} ${message}</p></div>`;
  }
}

// Clear auth result
function clearAuthResult() {
  const resultDiv = document.getElementById('auth-result');
  if (resultDiv) {
    resultDiv.innerHTML = '';
  }
}

function handleLoginClick() {
  // Check if user is already logged in
  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // User is logged in, logout
    handleLogoutFromButton();
  } else {
    // User not logged in, show login modal
    showLoginModal();
  }
}

// Handle logout from the button
async function handleLogoutFromButton() {
  if (window.sessionManager) {
    try {
      await window.sessionManager.logout();
      showMessage('âœ… Logged out successfully', 'success');
      updateLoginButtonState();
      // Reload or redirect after logout
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    } catch (error) {
      console.error('Logout error:', error);
      showMessage('âŒ Logout failed: ' + error.message, 'error');
    }
  }
}

// Update button state based on authentication status
function updateLoginButtonState() {
  const button = document.getElementById('login-btn');
  const buttonText = document.getElementById('login-btn-text');

  if (!button || !buttonText) return;

  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // User is logged in - show logout button
    buttonText.innerHTML = 'ğŸšª Logout';
    button.title = 'Logout';
  } else {
    // User is not logged in - show login button
    buttonText.innerHTML = 'ğŸ—ï¸ Login';
    button.title = 'Login';
  }
}

function showLoginModal() {
  const modal = document.getElementById('login-modal');
  modal.classList.remove('hidden');
}

function hideLoginModal() {
  document.getElementById('login-modal').classList.add('hidden');
  hidePrivateKeyForm();
  hideGeneratedKeys();
}

function showPrivateKeyForm() {
  hideLoginModal();
  document.getElementById('private-key-modal').classList.remove('hidden');
}

function hidePrivateKeyForm() {
  document.getElementById('private-key-modal').classList.add('hidden');
  const input = document.getElementById('private-key-modal-input');
  const passwordInput = document.getElementById('encryption-password-modal-input');
  if (input) input.value = '';
  if (passwordInput) passwordInput.value = '';
}

// Login with private key and password
async function loginWithPrivateKeyAndPassword() {
  if (!window.sessionManager) {
    showMessage('âŒ Session manager not available', 'error');
    return;
  }

  const privateKey = document.getElementById('private-key-modal-input')?.value?.trim();
  const password = document.getElementById('encryption-password-modal-input')?.value?.trim();

  if (!privateKey) {
    showMessage('âŒ Please enter your private key', 'error');
    return;
  }

  if (!password) {
    showMessage('âŒ Please enter an encryption password', 'error');
    return;
  }

  try {
    showMessage('ğŸ—ï¸ Logging in with encrypted private key...', 'info');

    // Pass password as metadata for encryption
    await window.sessionManager.loginWithPrivateKey(privateKey, { password });

    // Clear inputs for security
    document.getElementById('private-key-modal-input').value = '';
    document.getElementById('encryption-password-modal-input').value = '';

    hidePrivateKeyForm();
    // Success handling is done by event listeners in auth.js
  } catch (error) {
    console.error('Private key login error:', error);
    showMessage('âŒ Private key login failed: ' + error.message, 'error');
  }
}

// Copy to clipboard function with mobile fallback
function copyToClipboard(elementId, label) {
  const element = document.getElementById(elementId);
  if (!element) return;

  const text = element.textContent;
  if (!text) return;

  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showMessage(`âœ… ${label} copied!`, 'success');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopyTextToClipboard(text, label);
    });
  } else {
    // Fallback for older browsers and mobile
    fallbackCopyTextToClipboard(text, label);
  }
}

// Fallback copy method using textarea
function fallbackCopyTextToClipboard(text, label) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.top = '0';
  textArea.style.left = '0';
  textArea.style.width = '2em';
  textArea.style.height = '2em';
  textArea.style.padding = '0';
  textArea.style.border = 'none';
  textArea.style.outline = 'none';
  textArea.style.boxShadow = 'none';
  textArea.style.background = 'transparent';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showMessage(`âœ… ${label} copied!`, 'success');
    } else {
      showMessage('âŒ Failed to copy to clipboard', 'error');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    showMessage('âŒ Failed to copy to clipboard', 'error');
  }

  document.body.removeChild(textArea);
}

function hideGeneratedKeys() {
  document.getElementById('generated-keys-modal').classList.add('hidden');
  document.getElementById('gen-npub').textContent = '';
  document.getElementById('gen-nsec').textContent = '';
  generatedPrivateKey = null;
}

function showGeneratedKeys(keyPair) {
  hideLoginModal();
  document.getElementById('gen-npub').textContent = keyPair.npub;
  document.getElementById('gen-nsec').textContent = keyPair.nsec;
  generatedPrivateKey = keyPair.nsec;
  document.getElementById('generated-keys-modal').classList.remove('hidden');
}

function useGeneratedKeys() {
  if (generatedPrivateKey) {
    loginWithPrivateKey(generatedPrivateKey);
    hideGeneratedKeys();
  }
}

// Override the existing generateNewKeys function to work with dropdown
async function generateNewKeys() {
  if (!window.sessionManager) {
    showMessage('âŒ Session manager not available', 'error');
    return;
  }

  try {
    showMessage('âœ¨ Generating new key pair...', 'info');
    const keyPair = await window.sessionManager.generateKeys();

    if (keyPair) {
      showGeneratedKeys(keyPair);
      showMessage('âœ… Keys generated successfully!', 'success');
    } else {
      showMessage('âŒ Failed to generate keys', 'error');
    }
  } catch (error) {
    console.error('Key generation error:', error);
    showMessage('âŒ Key generation failed: ' + error.message, 'error');
  }
}

// Override the loginWithPrivateKey function to work with dropdown
async function loginWithPrivateKey(privateKeyParam) {
  if (!window.sessionManager) {
    showMessage('âŒ Session manager not available', 'error');
    return;
  }

  const privateKey = privateKeyParam || document.querySelector('.private-key-input').value.trim();

  if (!privateKey) {
    showMessage('âŒ Please enter your private key', 'error');
    return;
  }

  try {
    showMessage('ğŸ—ï¸ Logging in with private key...', 'info');
    await window.sessionManager.loginWithPrivateKey(privateKey);

    // Clear the input for security
    if (!privateKeyParam) {
      document.querySelector('.private-key-input').value = '';
    }

    hideLoginModal();
    // Success handling is done by event listeners in auth.js
  } catch (error) {
    console.error('Private key login error:', error);
    showMessage('âŒ Private key login failed: ' + error.message, 'error');
  }
}

function showSaveSelection() {
  // Navigate to save selection page
  window.location.href = '/saves';
}

// Initialize button state when page loads
if (typeof window !== 'undefined') {
  // Update button state on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateLoginButtonState);
  } else {
    updateLoginButtonState();
  }

  // Listen for authentication state changes
  if (window.sessionManager) {
    window.sessionManager.on('authenticationSuccess', updateLoginButtonState);
    window.sessionManager.on('loggedOut', updateLoginButtonState);
    window.sessionManager.on('sessionReady', updateLoginButtonState);
  } else {
    // Wait for session manager to be available
    const checkSessionManager = setInterval(() => {
      if (window.sessionManager) {
        clearInterval(checkSessionManager);
        window.sessionManager.on('authenticationSuccess', updateLoginButtonState);
        window.sessionManager.on('loggedOut', updateLoginButtonState);
        window.sessionManager.on('sessionReady', updateLoginButtonState);
        updateLoginButtonState();
      }
    }, 100);
  }
}
</script>
{{end}}