{{define "nav-play"}}
<!-- Login/Logout Button -->
<button
  id="login-btn"
  onclick="handleLoginClick()"
  class="login-button pixel-clip px-3 py-2 sm:px-8 sm:py-3 font-bold transition-all hover:scale-105"
  style="font-size: 0.65rem; background: rgb(46, 125, 50) !important;"
>
  <span class="flex items-center gap-1 sm:gap-2 sm:text-base" id="login-btn-text">
    🔑 Login
  </span>
</button>

<!-- Login Modal (Hidden by default) -->
<div
  id="login-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideLoginModal()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-2xl max-h-[90vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-6 sm:p-8">
      <!-- Header -->
      <div class="text-center mb-6">
        <h2 class="text-3xl sm:text-4xl font-bold mb-2" style="color: var(--color-textHighlighted);">⚔️ Nostr Hero ⚔️</h2>
        <p class="text-sm sm:text-base" style="color: var(--color-textMuted);">Login with your Nostr identity to save your progress</p>
      </div>

      <!-- Login Methods -->
      <div class="space-y-4 mb-6">
        <!-- Browser Extension -->
        <div class="win95-inset p-4">
          <div class="flex items-start gap-4">
            <div class="text-4xl">🔗</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1" style="color: var(--color-textPrimary);">Browser Extension</h4>
              <p class="text-sm mb-3" style="color: var(--color-textMuted);">Use Alby, nos2x, or other Nostr browser extensions</p>
              <button
                onclick="loginWithExtension()"
                class="blue-button px-6 py-2 font-medium pixel-clip"
                style="background: rgb(29, 78, 216) !important;"
              >
                Connect Extension
              </button>
            </div>
          </div>
        </div>

        <!-- Amber (Android) -->
        <div class="win95-inset p-4">
          <div class="flex items-start gap-4">
            <div class="text-4xl">📱</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1" style="color: var(--color-textPrimary);">Amber Signer</h4>
              <p class="text-sm mb-3" style="color: var(--color-textMuted);">Android app for secure key management</p>
              <button
                onclick="loginWithAmber()"
                class="orange-button px-6 py-2 font-medium pixel-clip"
                style="background: rgb(234, 88, 12) !important;"
              >
                Connect Amber
              </button>
            </div>
          </div>
        </div>

        <!-- Private Key -->
        <div class="win95-inset p-4">
          <div class="flex items-start gap-4">
            <div class="text-4xl">🗝️</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1" style="color: var(--color-textPrimary);">Private Key</h4>
              <p class="text-sm mb-3" style="color: var(--color-textMuted);">Login with your nsec or hex private key (encrypted with password for session)</p>
              <button
                onclick="showPrivateKeyForm()"
                class="red-button px-6 py-2 font-medium pixel-clip"
                style="background: rgb(185, 28, 28) !important;"
              >
                Enter Private Key
              </button>
            </div>
          </div>
        </div>

        <!-- Generate New Keys -->
        <div class="win95-inset p-4">
          <div class="flex items-start gap-4">
            <div class="text-4xl">✨</div>
            <div class="flex-1">
              <h4 class="font-bold mb-1" style="color: var(--color-textPrimary);">New to Nostr?</h4>
              <p class="text-sm mb-3" style="color: var(--color-textMuted);">Generate a new keypair and start your adventure</p>
              <button
                onclick="generateNewKeys()"
                class="purple-button px-6 py-2 font-medium pixel-clip"
                style="background: rgb(126, 34, 206) !important;"
              >
                Generate New Keys
              </button>
            </div>
          </div>
        </div>
      </div>


      <!-- Info Section -->
      <div class="text-xs text-center mb-4" style="color: var(--color-textMuted);">
        <p>🔐 Your keys are never sent to our servers</p>
        <p class="mt-1">All signing happens locally in your browser or signer app</p>
      </div>

      <!-- Close Button -->
      <button
        onclick="hideLoginModal()"
        class="w-full win95-button pixel-clip px-4 py-2 text-sm font-medium"
        style="color: var(--color-textPrimary);"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Private Key Modal (Initially Hidden) -->
<div
  id="private-key-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hidePrivateKeyForm()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-md"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-6">
      <h3 class="text-2xl font-bold mb-4 text-center" style="color: var(--color-textHighlighted);">🗝️ Enter Private Key</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--color-textSecondary);">Private Key</label>
          <input
            type="password"
            id="private-key-modal-input"
            class="w-full win95-inset px-3 py-2 focus:outline-none font-mono text-sm"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="nsec1... or hex private key"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2" style="color: var(--color-textSecondary);">Encryption Password</label>
          <input
            type="password"
            id="encryption-password-modal-input"
            class="w-full win95-inset px-3 py-2 focus:outline-none text-sm"
            style="color: var(--color-textPrimary); background-color: var(--color-bgPrimary);"
            placeholder="Password to encrypt your key"
          />
        </div>
        <div class="text-xs win95-inset p-3" style="color: var(--color-textMuted);">
          <p>🔒 Your private key will be encrypted with your password and stored securely for this session only.</p>
        </div>
        <div class="flex gap-2">
          <button
            onclick="loginWithPrivateKeyAndPassword()"
            class="flex-1 login-button pixel-clip px-4 py-3 font-medium"
            style="background: rgb(46, 125, 50) !important;"
          >
            Login
          </button>
          <button
            onclick="hidePrivateKeyForm()"
            class="flex-1 win95-button pixel-clip px-4 py-3"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Generated Keys Modal (Initially Hidden) -->
<div
  id="generated-keys-modal"
  class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
  style="background-color: rgba(0, 0, 0, 0.85);"
  onclick="if(event.target === this) hideGeneratedKeys()"
>
  <div
    class="win95-outset pixel-clip w-full max-w-2xl max-h-[90vh] overflow-y-auto"
    style="border: 4px solid var(--color-textPrimary);"
    onclick="event.stopPropagation()"
  >
    <div class="p-6">
      <h3 class="text-2xl font-bold mb-4 text-center" style="color: var(--color-textHighlighted);">✨ New Keys Generated!</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold mb-2" style="color: rgb(59, 130, 246);">📄 Public Key (npub)</label>
          <div class="flex gap-2">
            <div class="flex-1 win95-inset p-3 text-xs font-mono break-all" style="color: rgb(59, 130, 246); background: var(--color-bgPrimary);" id="gen-npub"></div>
            <button onclick="copyToClipboard('gen-npub', '📄 Public key')" class="blue-button px-4 py-2 pixel-clip text-sm" style="background: rgb(29, 78, 216) !important;">Copy</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-bold mb-2" style="color: rgb(239, 68, 68);">🔒 Private Key (nsec)</label>
          <div class="flex gap-2">
            <div class="flex-1 win95-inset p-3 text-xs font-mono break-all" style="color: rgb(239, 68, 68); background: var(--color-bgPrimary);" id="gen-nsec"></div>
            <button onclick="copyToClipboard('gen-nsec', '🔒 Private key')" class="red-button px-4 py-2 pixel-clip text-sm" style="background: rgb(185, 28, 28) !important;">Copy</button>
          </div>
        </div>
        <div class="text-sm win95-inset p-4" style="background: var(--color-bgTertiary); color: var(--color-textHighlighted);">
          <p class="font-bold">⚠️ CRITICAL - SAVE YOUR PRIVATE KEY!</p>
          <p class="mt-2">This is the ONLY way to access your account. Copy and store it in a password manager or write it down securely. Anyone with this key controls your account.</p>
        </div>
        <div class="flex gap-2">
          <button
            onclick="useGeneratedKeys()"
            class="flex-1 login-button pixel-clip px-4 py-3 font-medium"
            style="background: rgb(46, 125, 50) !important;"
          >
            I Saved It - Continue
          </button>
          <button
            onclick="hideGeneratedKeys()"
            class="flex-1 win95-button pixel-clip px-4 py-3"
            style="color: var(--color-textPrimary);"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variable to store generated private key
if (typeof generatedPrivateKey === 'undefined') {
  var generatedPrivateKey = null;
}

function handleLoginClick() {
  // Check if user is already logged in
  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // User is logged in, logout
    handleLogoutFromButton();
  } else {
    // User not logged in, show login modal
    showLoginModal();
  }
}

// Handle logout from the button
async function handleLogoutFromButton() {
  if (window.sessionManager) {
    try {
      await window.sessionManager.logout();
      showMessage('✅ Logged out successfully', 'success');
      updateLoginButtonState();
      // Reload or redirect after logout
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    } catch (error) {
      console.error('Logout error:', error);
      showMessage('❌ Logout failed: ' + error.message, 'error');
    }
  }
}

// Update button state based on authentication status
function updateLoginButtonState() {
  const button = document.getElementById('login-btn');
  const buttonText = document.getElementById('login-btn-text');

  if (!button || !buttonText) return;

  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // User is logged in - show logout button
    button.classList.remove('login-button');
    button.classList.add('logout-button');
    button.style.cssText = 'font-size: 0.65rem; background: rgb(183, 28, 28) !important;';
    buttonText.innerHTML = '🚪 Logout';
  } else {
    // User is not logged in - show login button
    button.classList.remove('logout-button');
    button.classList.add('login-button');
    button.style.cssText = 'font-size: 0.65rem; background: rgb(46, 125, 50) !important;';
    buttonText.innerHTML = '🔑 Login';
  }
}

function showLoginModal() {
  const modal = document.getElementById('login-modal');
  modal.classList.remove('hidden');
}

function hideLoginModal() {
  document.getElementById('login-modal').classList.add('hidden');
  hidePrivateKeyForm();
  hideGeneratedKeys();
}

function showPrivateKeyForm() {
  hideLoginModal();
  document.getElementById('private-key-modal').classList.remove('hidden');
}

function hidePrivateKeyForm() {
  document.getElementById('private-key-modal').classList.add('hidden');
  const input = document.getElementById('private-key-modal-input');
  const passwordInput = document.getElementById('encryption-password-modal-input');
  if (input) input.value = '';
  if (passwordInput) passwordInput.value = '';
}

// Login with private key and password
async function loginWithPrivateKeyAndPassword() {
  if (!window.sessionManager) {
    showMessage('❌ Session manager not available', 'error');
    return;
  }

  const privateKey = document.getElementById('private-key-modal-input')?.value?.trim();
  const password = document.getElementById('encryption-password-modal-input')?.value?.trim();

  if (!privateKey) {
    showMessage('❌ Please enter your private key', 'error');
    return;
  }

  if (!password) {
    showMessage('❌ Please enter an encryption password', 'error');
    return;
  }

  try {
    showMessage('🗝️ Logging in with encrypted private key...', 'info');

    // Pass password as metadata for encryption
    await window.sessionManager.loginWithPrivateKey(privateKey, { password });

    // Clear inputs for security
    document.getElementById('private-key-modal-input').value = '';
    document.getElementById('encryption-password-modal-input').value = '';

    hidePrivateKeyForm();
    // Success handling is done by event listeners in auth.js
  } catch (error) {
    console.error('Private key login error:', error);
    showMessage('❌ Private key login failed: ' + error.message, 'error');
  }
}

// Copy to clipboard function
function copyToClipboard(elementId, label) {
  const element = document.getElementById(elementId);
  if (!element) return;

  const text = element.textContent;
  if (!text) return;

  navigator.clipboard.writeText(text).then(() => {
    showMessage(`✅ ${label} copied to clipboard!`, 'success');
  }).catch(err => {
    console.error('Failed to copy:', err);
    showMessage('❌ Failed to copy to clipboard', 'error');
  });
}

function hideGeneratedKeys() {
  document.getElementById('generated-keys-modal').classList.add('hidden');
  document.getElementById('gen-npub').textContent = '';
  document.getElementById('gen-nsec').textContent = '';
  generatedPrivateKey = null;
}

function showGeneratedKeys(keyPair) {
  hideLoginModal();
  document.getElementById('gen-npub').textContent = keyPair.npub;
  document.getElementById('gen-nsec').textContent = keyPair.nsec;
  generatedPrivateKey = keyPair.nsec;
  document.getElementById('generated-keys-modal').classList.remove('hidden');
}

function useGeneratedKeys() {
  if (generatedPrivateKey) {
    loginWithPrivateKey(generatedPrivateKey);
    hideGeneratedKeys();
  }
}

// Override the existing generateNewKeys function to work with dropdown
async function generateNewKeys() {
  if (!window.sessionManager) {
    showMessage('❌ Session manager not available', 'error');
    return;
  }

  try {
    showMessage('✨ Generating new key pair...', 'info');
    const keyPair = await window.sessionManager.generateKeys();

    if (keyPair) {
      showGeneratedKeys(keyPair);
      showMessage('✅ Keys generated successfully!', 'success');
    } else {
      showMessage('❌ Failed to generate keys', 'error');
    }
  } catch (error) {
    console.error('Key generation error:', error);
    showMessage('❌ Key generation failed: ' + error.message, 'error');
  }
}

// Override the loginWithPrivateKey function to work with dropdown
async function loginWithPrivateKey(privateKeyParam) {
  if (!window.sessionManager) {
    showMessage('❌ Session manager not available', 'error');
    return;
  }

  const privateKey = privateKeyParam || document.querySelector('.private-key-input').value.trim();

  if (!privateKey) {
    showMessage('❌ Please enter your private key', 'error');
    return;
  }

  try {
    showMessage('🗝️ Logging in with private key...', 'info');
    await window.sessionManager.loginWithPrivateKey(privateKey);

    // Clear the input for security
    if (!privateKeyParam) {
      document.querySelector('.private-key-input').value = '';
    }

    hideLoginModal();
    // Success handling is done by event listeners in auth.js
  } catch (error) {
    console.error('Private key login error:', error);
    showMessage('❌ Private key login failed: ' + error.message, 'error');
  }
}

function showSaveSelection() {
  // Navigate to save selection page
  window.location.href = '/saves';
}

// Initialize button state when page loads
if (typeof window !== 'undefined') {
  // Update button state on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateLoginButtonState);
  } else {
    updateLoginButtonState();
  }

  // Listen for authentication state changes
  if (window.sessionManager) {
    window.sessionManager.on('authenticationSuccess', updateLoginButtonState);
    window.sessionManager.on('loggedOut', updateLoginButtonState);
    window.sessionManager.on('sessionReady', updateLoginButtonState);
  } else {
    // Wait for session manager to be available
    const checkSessionManager = setInterval(() => {
      if (window.sessionManager) {
        clearInterval(checkSessionManager);
        window.sessionManager.on('authenticationSuccess', updateLoginButtonState);
        window.sessionManager.on('loggedOut', updateLoginButtonState);
        window.sessionManager.on('sessionReady', updateLoginButtonState);
        updateLoginButtonState();
      }
    }, 100);
  }
}
</script>
{{end}}