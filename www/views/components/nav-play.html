{{define "nav-play"}}
<!-- Play Button with Login Dropdown -->
<div class="relative">
  <button
    id="play-btn"
    onclick="handlePlayClick()"
    class="relative group rounded-lg px-8 py-3 border-2 border-transparent bg-green-900 text-white text-xl font-bold tracking-wider transition-all duration-500 overflow-hidden hover:shadow-[0_0_12px_2px] hover:shadow-green-600/50"
  >
    <span class="relative z-10 flex items-center gap-2">
      ‚öîÔ∏è PLAY
    </span>

    <!-- Dark base layer -->
    <span class="absolute inset-0 bg-green-800/80"></span>

    <!-- Animated energy flow -->
    <span
      class="absolute inset-0 opacity-60 group-hover:opacity-40 transition-opacity duration-700 animate-liquid-flow bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-green-600/70 via-transparent to-green-600/50"
    ></span>

    <!-- Pulsing outline -->
    <span
      class="absolute -inset-[2px] rounded-lg border-2 border-green-600 opacity-50 group-hover:opacity-100 transition-opacity duration-300 animate-pulse-glow-green"
    ></span>
  </button>

  <!-- Login Dropdown (Hidden by default) -->
  <div
    id="login-dropdown"
    class="hidden absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-80 bg-gray-800 border-2 border-green-600 rounded-lg shadow-xl z-50"
  >
    <div class="p-6">
      <h3 class="text-xl font-bold text-green-400 mb-4 text-center">Login to Play</h3>

      <!-- Login Methods -->
      <div class="space-y-3">
        <button
          onclick="loginWithExtension()"
          class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
        >
          üîó Browser Extension
        </button>

        <button
          onclick="loginWithAmber()"
          class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
        >
          üì± Amber (Android)
        </button>

        <button
          onclick="showPrivateKeyForm()"
          class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
        >
          üóùÔ∏è Private Key
        </button>

        <button
          onclick="generateNewKeys()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
        >
          ‚ú® Generate New Keys
        </button>
      </div>

      <!-- Private Key Form (Initially Hidden) -->
      <div id="private-key-form" class="hidden mt-4 pt-4 border-t border-gray-600">
        <div class="space-y-3">
          <input
            type="password"
            class="private-key-input w-full bg-gray-700 text-white px-3 py-2 rounded border border-gray-600 focus:border-green-400 focus:outline-none"
            placeholder="nsec... or hex private key"
          />
          <div class="flex space-x-2">
            <button
              onclick="loginWithPrivateKey()"
              class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors"
            >
              Login
            </button>
            <button
              onclick="hidePrivateKeyForm()"
              class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
        <div class="mt-3 text-sm text-gray-400">
          <p>‚ö†Ô∏è Your key is encrypted and stored securely for this session only.</p>
        </div>
      </div>

      <!-- Generated Keys Display (Initially Hidden) -->
      <div id="generated-keys-display" class="hidden mt-4 pt-4 border-t border-gray-600">
        <h4 class="text-lg font-bold text-green-400 mb-3">New Keys Generated!</h4>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Public Key (npub)</label>
            <div class="bg-gray-700 p-2 rounded text-xs font-mono text-green-400 break-all" id="gen-npub">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Private Key (nsec)</label>
            <div class="bg-gray-700 p-2 rounded text-xs font-mono text-red-400 break-all" id="gen-nsec">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
          <div class="text-sm text-yellow-400 bg-yellow-900 bg-opacity-20 p-3 rounded">
            <p><strong>‚ö†Ô∏è IMPORTANT:</strong> Save your private key (nsec) securely! Anyone with this key can control your account.</p>
          </div>
          <div class="flex space-x-2">
            <button
              onclick="useGeneratedKeys()"
              class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium transition-colors"
            >
              Use These Keys
            </button>
            <button
              onclick="hideGeneratedKeys()"
              class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Close Button -->
      <button
        onclick="hideLoginDropdown()"
        class="mt-4 w-full text-gray-400 hover:text-white text-sm transition-colors"
      >
        Cancel
      </button>
    </div>
  </div>
</div>

<style>
  @keyframes pulse-glow-green {
    0% {
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      border-width: 2px;
    }
    70% {
      box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
      border-width: 1px;
    }
    100% {
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      border-width: 2px;
    }
  }

  @keyframes liquid-flow {
    0% {
      background-position: 0% 50%;
      background-size: 400% 400%;
    }
    50% {
      background-position: 100% 50%;
      background-size: 500% 500%;
    }
    100% {
      background-position: 0% 50%;
      background-size: 400% 400%;
    }
  }

  .animate-pulse-glow-green {
    animation: pulse-glow-green 2s infinite;
  }

  .animate-liquid-flow {
    animation: liquid-flow 6s ease infinite;
  }
</style>

<script>
// Global variable to store generated private key
if (typeof generatedPrivateKey === 'undefined') {
  var generatedPrivateKey = null;
}

function handlePlayClick() {
  // Check if user is already logged in
  if (window.sessionManager && window.sessionManager.isAuthenticated()) {
    // User is logged in, proceed to save selection
    showSaveSelection();
  } else {
    // User not logged in, show login dropdown
    showLoginDropdown();
  }
}

function showLoginDropdown() {
  const dropdown = document.getElementById('login-dropdown');
  dropdown.classList.remove('hidden');

  // Close dropdown when clicking outside
  setTimeout(() => {
    const closeDropdown = (event) => {
      if (!dropdown.contains(event.target) && !document.getElementById('play-btn').contains(event.target)) {
        hideLoginDropdown();
        document.removeEventListener('click', closeDropdown);
      }
    };
    document.addEventListener('click', closeDropdown);
  }, 100);
}

function hideLoginDropdown() {
  document.getElementById('login-dropdown').classList.add('hidden');
  hidePrivateKeyForm();
  hideGeneratedKeys();
}

function showPrivateKeyForm() {
  document.getElementById('private-key-form').classList.remove('hidden');
}

function hidePrivateKeyForm() {
  document.getElementById('private-key-form').classList.add('hidden');
  document.querySelector('.private-key-input').value = '';
}

function hideGeneratedKeys() {
  document.getElementById('generated-keys-display').classList.add('hidden');
  document.getElementById('gen-npub').textContent = '';
  document.getElementById('gen-nsec').textContent = '';
  generatedPrivateKey = null;
}

function showGeneratedKeys(keyPair) {
  document.getElementById('gen-npub').textContent = keyPair.npub;
  document.getElementById('gen-nsec').textContent = keyPair.nsec;
  generatedPrivateKey = keyPair.nsec;
  document.getElementById('generated-keys-display').classList.remove('hidden');
}

function useGeneratedKeys() {
  if (generatedPrivateKey) {
    loginWithPrivateKey(generatedPrivateKey);
    hideGeneratedKeys();
  }
}

// Override the existing generateNewKeys function to work with dropdown
async function generateNewKeys() {
  if (!window.sessionManager) {
    showMessage('‚ùå Session manager not available', 'error');
    return;
  }

  try {
    showMessage('‚ú® Generating new key pair...', 'info');
    const keyPair = await window.sessionManager.generateKeys();

    if (keyPair) {
      showGeneratedKeys(keyPair);
      showMessage('‚úÖ Keys generated successfully!', 'success');
    } else {
      showMessage('‚ùå Failed to generate keys', 'error');
    }
  } catch (error) {
    console.error('Key generation error:', error);
    showMessage('‚ùå Key generation failed: ' + error.message, 'error');
  }
}

// Override the loginWithPrivateKey function to work with dropdown
async function loginWithPrivateKey(privateKeyParam) {
  if (!window.sessionManager) {
    showMessage('‚ùå Session manager not available', 'error');
    return;
  }

  const privateKey = privateKeyParam || document.querySelector('.private-key-input').value.trim();

  if (!privateKey) {
    showMessage('‚ùå Please enter your private key', 'error');
    return;
  }

  try {
    showMessage('üóùÔ∏è Logging in with private key...', 'info');
    await window.sessionManager.loginWithPrivateKey(privateKey);

    // Clear the input for security
    if (!privateKeyParam) {
      document.querySelector('.private-key-input').value = '';
    }

    hideLoginDropdown();
    // Success handling is done by event listeners in auth.js
  } catch (error) {
    console.error('Private key login error:', error);
    showMessage('‚ùå Private key login failed: ' + error.message, 'error');
  }
}

function showSaveSelection() {
  // Navigate to save selection page
  window.location.href = '/saves';
}
</script>
{{end}}